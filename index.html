<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>IPA解析</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f9f9f9;
            display: flex;
            justify-content: center; /* 水平居中 */
            align-items: center; /* 垂直居中 */
            height: 100vh; /* 让内容占满整个屏幕 */
            overflow: hidden; /* 防止页面滚动 */
        }
        .container {
            max-width: 600px;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center; /* 将内容居中 */
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        input[type="file"] {
            display: block;
            margin: 0 auto 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: calc(100% - 22px); /* 计算宽度以确保左右一致 */
            cursor: pointer;
            box-sizing: border-box; /* 包括内边距和边框在内的计算宽度 */
        }
        h2 {
            color: #555;
            margin: 0;
            padding-top: 10px;
        }
        pre {
            background-color: #f1f1f1;
            padding: 10px;
            border-radius: 5px;
            white-space: pre; /* 保持格式，允许多行 */
            overflow-x: auto; /* 支持横向滚动 */
            max-height: 300px; /* 最大高度 */
            margin: 0;
            text-align: left; /* 文本左对齐 */
        }
        .alert {
            color: red;
            text-align: center;
            margin: 10px 0;
        }
        .icon {
            display: block;
            margin: 20px auto 10px; /* 图标居中，设置上下间距 */
            max-width: 100px; /* 图标最大宽度 */
            max-height: 100px; /* 图标最大高度 */
        }
        .app-info {
            text-align: left; /* 让应用信息左对齐 */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>IPA解析</h1>
        <input type="file" id="fileInput" accept=".ipa"> <!-- 仅接受IPA文件 -->
        <div class="alert" id="alertMessage"></div> <!-- 显示警告信息 -->
        <img id="appIcon" class="icon" alt="应用图标" style="display: none;"> <!-- 显示应用图标 -->
        <div class="app-info">
            <h2>Info.plist内容:</h2>
            <pre id="infoPlistOutput"></pre> <!-- 显示Info.plist内容 -->
        </div>
    </div>

    <script>
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const fileExtension = file.name.split('.').pop().toLowerCase();
                if (fileExtension !== 'ipa') {
                    showAlert('请选择一个IPA文件！');
                    event.target.value = ''; // 清空文件输入框
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const zip = new JSZip();
                    zip.loadAsync(e.target.result)
                        .then(function(contents) {
                            // 搜索Payload文件夹
                            const payloadFolder = Object.keys(contents.files).find(function(path) {
                                return path.startsWith('Payload/');
                            });

                            if (!payloadFolder) {
                                showAlert('未找到Payload文件夹');
                                return;
                            }

                            // 搜索.app文件夹
                            const appFolder = Object.keys(contents.files).find(function(path) {
                                return path.startsWith(payloadFolder) && path.endsWith('.app/');
                            });

                            if (!appFolder) {
                                showAlert('未找到.app文件夹');
                                return;
                            }

                            // 搜索并读取Info.plist文件
                            const infoPlistPath = appFolder + 'Info.plist';

                            if (!contents.files[infoPlistPath]) {
                                showAlert('未找到Info.plist文件');
                                return;
                            }

                            // 读取Info.plist文件内容
                            return contents.files[infoPlistPath].async('text')
                                .then(infoPlistContent => {
                                    // 解析Info.plist内容
                                    const parser = new DOMParser();
                                    const xmlDoc = parser.parseFromString(infoPlistContent, "text/xml");
                                    const keys = xmlDoc.getElementsByTagName("key");
                                    const result = {};

                                    // 获取特定字段
                                    const fieldsToExtract = ['CFBundleDisplayName', 'MinimumOSVersion', 'CFBundleVersion', 'CFBundleIdentifier'];

                                    for (let i = 0; i < keys.length; i++) {
                                        if (fieldsToExtract.includes(keys[i].textContent)) {
                                            result[keys[i].textContent] = keys[i].nextElementSibling.textContent;
                                        }
                                    }

                                    // 检查是否成功解析所需字段
                                    const missingFields = fieldsToExtract.filter(field => !result[field]);
                                    if (missingFields.length > 0) {
                                        showAlert('无法解析Info.plist，请手动打开并检查内容。');
                                        document.getElementById('infoPlistOutput').textContent = ''; // 清空输出
                                        return;
                                    }

                                    // 格式化输出
                                    const output = `
应用名称: ${result['CFBundleDisplayName'] || '未找到'}
版本: ${result['CFBundleVersion'] || '未找到'}
适配iOS版本: ${result['MinimumOSVersion'] || '未找到'}
包名: ${result['CFBundleIdentifier'] || '未找到'}
                                    `;

                                    // 显示结果
                                    document.getElementById('infoPlistOutput').textContent = output;
                                    document.getElementById('alertMessage').textContent = ''; // 清空警告信息

                                    // 尝试显示应用图标
                                    const iconPath = appFolder + 'AppIcon60x60@2x.png'; // 假设图标路径
                                    return contents.files[iconPath]?.async('base64'); // 读取图标文件
                                })
                                .then(iconData => {
                                    if (iconData) {
                                        const appIcon = document.getElementById('appIcon');
                                        appIcon.src = 'data:image/png;base64,' + iconData; // 设置图标为base64格式
                                        appIcon.style.display = 'block'; // 显示图标
                                    } else {
                                        document.getElementById('appIcon').style.display = 'none'; // 隐藏图标
                                    }
                                });
                        })
                        .catch(function(error) {
                            showAlert('文件处理失败: ' + error.message);
                        });
                };
                reader.readAsArrayBuffer(file); // 读取文件为二进制数组
            }
        });

        function showAlert(message) {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.textContent = message;
            setTimeout(() => {
                alertDiv.textContent = ''; // 清空警告信息
            }, 3000); // 3秒后自动清空
        }
    </script>
</body>
</html>
